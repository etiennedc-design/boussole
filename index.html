<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boussole de Granit</title>
    <style>
        :root {
            --primary: #d4af37; /* Or / Cuivre */
            --bg: #1a1a1a;
            --surface: #2d2d2d;
            --text: #e0e0e0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            background: var(--surface);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 85%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #3d3d3d;
        }

        h1 {
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 2rem;
            color: var(--primary);
        }

        /* Cadran de la boussole visuelle */
        .compass-ui {
            width: 200px;
            height: 200px;
            border: 2px solid var(--primary);
            border-radius: 50%;
            margin: 2rem auto;
            position: relative;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .compass-ui::after {
            content: 'N';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--primary);
            font-weight: bold;
        }

        .needle {
            position: absolute;
            width: 4px;
            height: 80px;
            background: var(--primary);
            top: 20px;
            left: 98px;
            border-radius: 2px;
            transform-origin: bottom center;
        }

        button {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 1rem;
        }

        button:hover {
            background: var(--primary);
            color: var(--bg);
        }

        button:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
        }

        #status {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: #888;
        }

        .coordinates {
            font-size: 0.7rem;
            color: #555;
            margin-top: 1rem;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Boussole</h1>
        
        <div class="compass-ui" id="compassVisual">
            <div class="needle"></div>
        </div>

        <button id="connectBtn">Connecter la pierre</button>
        
        <div id="status">En attente de connexion...</div>
        <div id="coords" class="coordinates"></div>
    </div>

    <script>
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        const PARIS = { lat: 48.8566, lon: 2.3522 };

        let characteristic;

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }

        document.getElementById('connectBtn').addEventListener('click', async () => {
            const status = document.getElementById('status');
            const compass = document.getElementById('compassVisual');
            
            try {
                status.innerText = "Recherche de la boussole...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Boussole_Granit' }],
                    optionalServices: [SERVICE_UUID]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                status.innerText = "Liaison établie. Calcul de l'azimut...";

                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const azimuth = Math.round(calculateBearing(pos.coords.latitude, pos.coords.longitude, PARIS.lat, PARIS.lon));
                    
                    // Animation de la boussole sur l'écran
                    compass.style.transform = `rotate(${-azimuth}deg)`;
                    
                    document.getElementById('coords').innerText = `LAT: ${pos.coords.latitude.toFixed(4)} / LON: ${pos.coords.longitude.toFixed(4)}`;
                    
                    // Envoi à l'ESP32
                    const data = new TextEncoder().encode(azimuth.toString());
                    await characteristic.writeValue(data);
                    
                    status.innerText = `Paris est à ${azimuth}°. Lampe synchronisée.`;
                    status.style.color = "#d4af37";
                });

            } catch (err) {
                status.innerText = "Erreur : " + err;
                console.error(err);
            }
        });
    </script>
</body>
</html>
