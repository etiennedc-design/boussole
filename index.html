let stableCount = 0;
let lastHeading = 0;
let filteredHeading = 0;
const ALPHA = 0.15; // Facteur de lissage (plus c'est bas, plus c'est stable/lent)

function startInstrument() {
    // 1. Demander la haute précision GPS
    navigator.geolocation.watchPosition(pos => {
        targetBearing = calcBearing(pos.coords.latitude, pos.coords.longitude, PARIS.lat, PARIS.lon);
        document.getElementById('dist-val').innerText = Math.round(calcDist(pos.coords.latitude, pos.coords.longitude, PARIS.lat, PARIS.lon)) + " KM";
    }, null, { enableHighAccuracy: true });

    // 2. Gestion de la boussole ABSOLUE
    const handleOrientation = (e) => {
        let heading = e.webkitCompassHeading || (360 - e.alpha);
        if (!heading) return;

        // --- FILTRE EMA (Lissage extrême) ---
        if (filteredHeading === 0) filteredHeading = heading;
        
        // Gestion du passage 359° -> 0° pour le filtre
        let diff = heading - filteredHeading;
        if (diff > 180) diff -= 360;
        if (diff < -180) diff += 360;
        filteredHeading = (filteredHeading + ALPHA * diff + 360) % 360;

        // --- CHECK DE STABILITÉ ---
        // Si l'angle bouge de moins de 1° par rapport à la dernière mesure
        if (Math.abs(heading - lastHeading) < 1.0) {
            stableCount++;
        } else {
            stableCount = 0;
        }
        lastHeading = heading;

        // On ne permet la validation que si c'est stable (env. 2-3 secondes)
        const btn = document.getElementById('main-btn');
        if (stableCount > 40) { // Environ 2 secondes à 20Hz
            btn.disabled = false;
            btn.style.opacity = "1";
            document.getElementById('status').innerText = "MESURE STABLE - PRÊT";
            document.getElementById('status').style.color = "var(--gold)";
        } else {
            btn.disabled = true;
            btn.style.opacity = "0.3";
            document.getElementById('status').innerText = "STABILISATION EN COURS...";
            document.getElementById('status').style.color = "#5a5f5f";
        }

        let visualAngle = (targetBearing - filteredHeading + 180) % 360;
        document.getElementById('needle-wrapper').style.transform = `rotate(${visualAngle}deg)`;
        document.getElementById('angle-val').innerText = Math.round(targetBearing) + "°";
    };

    if ('ondeviceorientationabsolute' in window) {
        window.addEventListener('deviceorientationabsolute', handleOrientation);
    } else {
        window.addEventListener('deviceorientation', handleOrientation);
    }
}
